<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <meta content='penguin home' name='description'>
    <meta content='ewe2' name='author'>
    <link href='/favicon.ico' rel='icon'>
    <title>ewe2.ninja</title>
    <!-- font links last -->
    <!-- Bootstrap core CSS -->
    <link href='/css/bootstrap.min.css' rel='stylesheet'>
    <!-- Custom styles for this template -->
    <link href='/css/stuff.css' media='screen' rel='stylesheet'>
    <!-- Highlighting -->
    <link href='/css/rouge.css' media='screen' rel='stylesheet'>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.min.js"></script>
      <script src="/js/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/index.html" class="navbar-brand">
        ewe2.ninja
      </a>
        
      </div>
      <div class="collapse navbar-collapse" id="navbar-collapse">
        <ul class="nav navbar-nav navbar-right" id="menu">
        <li>
        <a href="/">
          home
        </a>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">stuff <b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">
        Penguin stuff
      </li>
      <li>
        <a href="/stuff/">
          stuff
        </a>
      </li>
      <li class="divider"></li>
      <li>
        <a href="/music/">
          music
        </a>
      </li>
      <li>
        <a href="/computers/">
          computers
        </a>
      </li>
      <li>
        <a href="/random/">
          random
        </a>
      </li>
      
        </ul>
      </li>
      <li>
        <a href="/about">
          about
        </a>
      </li>
      
      </ul>
      
      </div>
    </nav>
    <div class='container-stuff'>
      <h2>An Exploration of Cno</h2>
      <h3 id="why-look-at-cno">Why look at Cno?</h3>
      
      <p>Cno is the unstripped and mysterious first binary that forms part of ching(6)
      which first appears in V7 Unix. But, as we will see, that's not its origin! It is a
      simple binary compared to its sister phx, but perhaps unique enough that it
      was treated differently afterwards. Phx was basically unchanged but Cno was
      altered several times! (see <a title="Ching" href="https://ewe2.ninja/stuff/ching">The strange case of the ching(6) in the Unix</a>)</p>
      
      <p>As an exercise in understanding V7 Unix and to recover its long-lost source we
      will disassemble cno. We'll use a few tools to do this: I have a copy of cno
      on my Linux system and the first tasks are to use <kbd>od</kbd> and
      <kbd>strings</kbd> to look for likely ways in.</p>
      
      <h4 id="using-strings">Using strings</h4>
      
      <p>After <kbd>strings cno</kbd> we have predictably little. Examining the file directly for strings,  we find some important additions, the
      word <kbd>log.a</kbd> as well as <kbd>%s</kbd> and then a long sequence <kbd>d o x f e g c s l L
      u r D O X * U</kbd> which is actually part of the code for converting variables
      in the printf() family. There is also some date-related strings following
      that. As we know there was a log file and it had a particular format, we can
      surmise that this is part of the code for that. It tells us definitely that C
      was the language used, which tells us a lot about how the program will be
      structured. If we cheat a little and look at the <kbd>phx</kbd> binary, we can
      see that "hexagrams.r" appears. That also tells us that C is being used as "r"
      and "a" are file handle flags: r for reading and a for text output.</p>
      
      <p>All this is at the end of the file, which tells us that there will be mostly
      library code appended by the linker, and references to it will be resolved in
      the preceding code, so it will be useful to find those addresses to find the
      system calls in the code. </p>
      
      <h4 id="code-hunting">Code-hunting</h4>
      
      <p>The C compiler in Unix emitted code for the Unix assembler to translate; this
      means it output code intended for the syntax of that assembler! <kbd>as</kbd>
      had some significant differences from the standard macro assembler from RT-11,
      particularly with input/output syntax. This is useful, because that gives us
      another place to hunt for code. Another source of entry (use the source,
      Luke!) are the optimizations used by the C compiler. This was before the era
      of optional optimization! One important one is explained in the compiler's
      sourcecode for the 2nd pass (usually the pass for resolving symbols):</p>
      
      <pre class="highlight plaintext"><code>
      /* Notice addresses of the form
       * $xx,xx(r)
       * and replace them with
       * (pc),xx(r)
       */
      </code></pre>
      
      <p><kbd>$</kbd> is "AT&amp;T syntax" for <kbd>#</kbd> in DEC assembler syntax, and is
      usually a PC instruction. Remember that destination precedes source in most PDP11
      operands, so this instruction is designed to reference the <em>address</em> of the
      program counter from a register address rather than the PC directly.</p>
      
      <h4 id="system-calls">System calls</h4>
      
      <p>Let's look for system calls. Helpfully, they're in a file
      <kbd>/usr/include/sys.s</kbd> in V7 and are numbered. <kbd>SYS</kbd> is just a
      synonym for <kbd>TRAP</kbd> in AT&amp;T syntax, so its machine code is
      <kbd>104400</kbd> and the masked bits are any number from 1 to 60. There are
      lots of calls, and some will be false positives. Here is a list in ascending
      order, with doubles and false positives weeded out:</p>
      
      <pre class="highlight plaintext"><code>
      104401 - exit
      104403 - read
      104404 - write
      104405 - open
      104406 - close
      104410 - unlink
      104415 - chmod
      104421 - mount
      104423 - setuid
      104424 - getuid
      104430 - utime.
      </code></pre>
      
      <p>There are many references to 104400 but that is a false positive. mount is an odd call also but more context is needed. setuid/getuid is very interesting, but may just be related to all the file calls which most of this stuff is dealing with. At least some of the calls will be for stdin/stdout and we know it writes a logfile.</p>
      
      <h4 id="library-calls">Library calls</h4>
      
      <p>These are trickier: calls to most library routines are simple JMP instructions or variants on JMP, even more opportunity to make false positives particularly with subroutines. What we can be sure of are RTS, returns from subroutines.</p>
      
      <h3 id="cno-black-box-theory">cno: Black Box Theory</h3>
      <p>When attempting to understand the internals of a machine or a program, it's helpful to get something to go on by considering what it takes as input and what it outputs. For instance, we know V7 cno wrote a log file of coin tosses in a particular format, we know that it could take random input or generated its own random input and it output six numbers for phx to interpret.</p>
      
      <h3 id="od-listing-header">od Listing: Header</h3>
      <pre class="highlight plaintext"><code>00000000 000407 007146 000766 002152 000000 000000 000000 000001
      </code></pre>
      
      <p>This first line of the od listing represents the a.out executable header:</p>
      
      <pre class="highlight c"><code>
      <span class="k">struct</span> <span class="n">exec</span> <span class="p">{</span>
          <span class="kt">int</span>         <span class="n">a_magic</span><span class="p">;</span> <span class="cm">/* magic number */</span>
          <span class="kt">unsigned</span>    <span class="n">a_text</span><span class="p">;</span> <span class="cm">/* size of text segment */</span>
          <span class="kt">unsigned</span>    <span class="n">a_data</span><span class="p">;</span> <span class="cm">/* size of initialized data */</span>
          <span class="kt">unsigned</span>    <span class="n">a_bss</span><span class="p">;</span>  <span class="cm">/* size of uninitialized data */</span>
          <span class="kt">unsigned</span>    <span class="n">a_syms</span><span class="p">;</span>  <span class="cm">/* size of symbol table */</span>
          <span class="kt">unsigned</span>    <span class="n">a_unused</span><span class="p">;</span>
          <span class="kt">unsigned</span>    <span class="n">a_flag</span><span class="p">;</span> <span class="cm">/* relocation info stripped */</span>
      <span class="p">};</span>
      </code></pre>
      
      <p>For now, <kbd>0407</kbd> means a normal executable, the next four fields are
      the sizes of each field. Note that the a_syms field is empty: the a_flag field
      is <kbd>01</kbd> meaning that it is stripped, so the symbol table has been
      zeroed. This also means that addresses have been resolved, so when we look for
      jumps and address references, we should find them hard-coded in the
      executable. We have 0766 bytes of variables but that is almost doubled by the
      space for uninitialized variables so we'll probably see a cast or two to some
      larger numbers.</p>
      
      <h3 id="od-listing-crt0">od Listing: crt0</h3>
      
      <pre class="highlight plaintext"><code>
      0000020 170011 010600 011046 005720 010066 000002 004767 000356
      0000040 022626 010016 004737 006040 104401
      </code></pre>
      
      <p>The next lines in the file make up the C runtime header that sets up the stack-based executing environment. It disassembles to the following:</p>
      
      <pre class="highlight cpp"><code>
      <span class="n">setd</span>
      <span class="n">mov</span> <span class="n">sp</span><span class="p">,</span> <span class="n">r0</span>       <span class="o">/</span> <span class="n">argc</span>
      <span class="n">mov</span> <span class="p">(</span><span class="n">r0</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>  <span class="o">/</span> <span class="n">argv</span>
      <span class="n">tst</span> <span class="p">(</span><span class="n">r0</span><span class="p">)</span><span class="o">+</span>        <span class="o">/</span> <span class="n">no</span> <span class="n">args</span><span class="o">?</span>
      <span class="n">mov</span> <span class="n">r0</span><span class="p">,</span> <span class="mi">2</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>    <span class="o">/</span> <span class="n">effectively</span> <span class="n">the</span> <span class="p">.</span><span class="n">bss</span>
      <span class="n">jsr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_main</span>    <span class="o">/</span> <span class="n">jump</span> <span class="n">to</span> <span class="n">main</span>
      <span class="n">cmp</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="o">+</span> <span class="o">/</span> <span class="n">check</span> <span class="n">argv</span>
      <span class="n">mov</span> <span class="n">r0</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>     <span class="o">/</span> <span class="n">push</span> <span class="n">argument</span> <span class="n">on</span> <span class="n">the</span> <span class="n">stack</span>
      <span class="n">jsr</span> <span class="n">pc</span><span class="p">,</span> <span class="o">*</span><span class="err">$</span><span class="n">_exit</span>  <span class="o">/</span> <span class="n">mode</span> <span class="mi">37</span> <span class="k">for</span> <span class="err">$</span><span class="n">expr</span><span class="p">.</span>
      <span class="n">sys</span> <span class="n">exit</span>
      </code></pre>
      
      <p>The BSS space reserved for an initial stack would later morph into
      <kbd>_environ</kbd> under because this isn't a V7 <kbd>crt0.s</kbd>, it's the
      much simpler V6 version. And in fact our suspicion this might be the case is
      strengthened by an interesting fact about many unix binaries: the assembled
      <kbd>crt0.s</kbd> differs and this binary indicates that it is a V6 binary,
      <em>not</em> a V7 binary. But let's be thorough and do some more work.</p>
      
      <h3 id="od-listing-further-on">od Listing: further on</h3>
      
      <pre class="highlight plaintext"><code>
      0000040 022626 010016 004737 006040 104401 004567 006264 016701
      0000060 007106 070127 031425 062701 015415 010167 007072 010100
      0000100 000167 006252 004567 006232 004767 177736 010001 005000
      0000120 071027 000021 005401 010146 004767 177716 010001 005000
      0000140 073026 010100 000167 006206 004567 006166 005746 005065
      0000160 177770 000402 060465 177770 005367 007210 002407 117700
      0000200 007200 042700 177400 005267 007170 000404 012716 007362
      0000220 004737 001140 010004 022704 177777 001354 005765 177770
      0000240 001004 012716 000001 004737 000040 016500 177770 000167
      </code></pre>
      
      <p>Picking up at byte 053, let's disassemble further</p>
      
      <pre class="highlight cpp"><code>
      <span class="o">/</span> <span class="n">_getrand</span>
      <span class="n">jsr</span> <span class="n">r5</span><span class="p">,</span> <span class="n">csv</span>            <span class="o">/</span> <span class="n">c</span> <span class="n">save</span> <span class="n">registers</span> <span class="p">(</span><span class="n">standard</span> <span class="n">library</span><span class="p">)</span>
      <span class="n">mov</span> <span class="n">word_7170</span><span class="p">,</span> <span class="n">r1</span>      <span class="o">/</span> <span class="n">we</span> <span class="n">grab</span> <span class="n">the</span> <span class="n">seed</span> <span class="n">from</span> <span class="n">here</span>
      <span class="n">mul</span> <span class="err">$</span><span class="mi">31425</span><span class="p">,</span> <span class="n">r1</span>         <span class="o">/</span> <span class="n">multiply</span> <span class="n">by</span> <span class="mi">13077</span>
      <span class="n">add</span> <span class="err">$</span><span class="mi">15415</span><span class="p">,</span> <span class="n">r1</span>         <span class="o">/</span> <span class="n">add</span> <span class="mi">6925</span>
      <span class="n">mov</span> <span class="n">r1</span><span class="p">,</span> <span class="n">word_7170</span>      <span class="o">/</span> <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">see</span> <span class="n">text</span><span class="o">!</span>
      <span class="n">mov</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r0</span>
      <span class="n">jmp</span> <span class="n">cret</span>               <span class="o">/</span> <span class="n">pop</span> <span class="n">regs</span>
      <span class="o">/</span> <span class="o">--</span> <span class="n">end</span> <span class="n">of</span> <span class="n">_getrand</span>
      
      <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">_getrnum</span>
      <span class="n">jsr</span> <span class="n">r5</span><span class="p">,</span> <span class="n">csv</span>            <span class="o">/</span> <span class="n">another</span> <span class="n">subroutine</span>
      <span class="n">jsr</span> <span class="n">pc</span> <span class="n">_getrand</span>        <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">subroutine</span>
      <span class="n">mov</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
      <span class="n">clr</span> <span class="n">r0</span>
      <span class="n">div</span> <span class="err">$</span><span class="mi">21</span><span class="p">,</span> <span class="n">r0</span>
      <span class="n">neg</span> <span class="n">r1</span>
      <span class="n">mov</span> <span class="n">r1</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>         <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">probably</span> <span class="n">a</span> <span class="n">parameter</span>
      <span class="n">jsr</span> <span class="n">pc</span> <span class="n">_getrand</span>
      <span class="n">mov</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span>
      <span class="n">clr</span> <span class="n">r0</span>
      <span class="n">ashc</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="o">+</span><span class="p">,</span> <span class="n">r0</span>        <span class="o">/</span> <span class="n">definitely</span> <span class="n">a</span> <span class="n">parameter</span> <span class="n">here</span>
      <span class="n">mov</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r0</span>
      <span class="n">jmp</span> <span class="n">cret</span>              <span class="o">/</span> <span class="n">end</span>
      <span class="o">/</span> <span class="n">end</span> <span class="n">of</span> <span class="n">_getrnum</span>
      
      <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">_getques</span>
      <span class="n">jsr</span> <span class="n">r5</span><span class="p">,</span> <span class="n">csv</span>
      <span class="n">tst</span> <span class="o">-</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
      <span class="n">clr</span> <span class="o">-</span><span class="mi">10</span><span class="p">(</span><span class="n">r5</span><span class="p">)</span>
      <span class="n">dec</span> <span class="n">word_7404</span>
      <span class="n">blt</span> <span class="n">loc_214</span>
      <span class="n">movb</span> <span class="err">$</span><span class="n">word_7402</span><span class="p">,</span> <span class="n">r0</span> <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">getting</span> <span class="n">from</span> <span class="n">__iob</span>
      <span class="n">bic</span> <span class="err">$</span><span class="o">-</span><span class="mi">400</span><span class="p">,</span> <span class="n">r0</span>       
      <span class="n">inc</span> <span class="n">word_7402</span>       <span class="o">/</span> <span class="n">incrementing</span> <span class="n">__iob</span>
      <span class="n">br</span> <span class="n">loc_224</span>
      <span class="n">mov</span> <span class="err">$</span><span class="mi">7362</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>     <span class="o">/</span> <span class="err">$</span><span class="n">__iob</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
      <span class="n">jsr</span> <span class="n">pc</span><span class="p">,</span>  <span class="o">*</span><span class="err">$</span><span class="n">_filbuf</span>
      <span class="n">mov</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r4</span>
      <span class="n">cmp</span> <span class="err">$</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r4</span>
      <span class="n">bne</span> <span class="n">loc_164</span>
      <span class="n">tst</span> <span class="o">-</span><span class="mi">10</span><span class="p">(</span><span class="n">r5</span><span class="p">)</span>         <span class="o">/</span> <span class="n">major</span> <span class="n">difference</span> <span class="n">here</span> <span class="n">to</span> <span class="n">v7</span><span class="o">-</span><span class="n">generated</span> <span class="n">code</span>
      <span class="n">bne</span> <span class="n">loc_252</span>
      <span class="n">mov</span> <span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
      <span class="n">jsr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">sub_6040</span>    <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">another</span> <span class="n">oddity</span><span class="p">.</span>
      <span class="n">mov</span> <span class="o">-</span><span class="mi">10</span><span class="p">(</span><span class="n">r5</span><span class="p">),</span> <span class="n">r0</span>
      <span class="n">jmp</span> <span class="n">cret</span>           <span class="o">/</span> <span class="n">pop</span>
      </code></pre>
      
      <p>At this point if we compare V7-generated code, we can see there are great
      similarities but also important differences. Subroutine setup is much simpler
      here. The assembler optimizes code differently in <kbd>_getques</kbd> and its
      I/O routine differs. This is further confirmation that here is a V6 binary
      pretending to be a V7 one. </p>
      
      <h3 id="od-finding-the-seed-routine">od: Finding the Seed Routine</h3>
      <p>So the first subroutine here had me wondering, clearly not <kbd>main()</kbd> but a function, and the answer comes from the Reno code by Guy Harris: it is indeed the original seed routine!</p>
      
      <pre class="highlight c"><code>
      <span class="kt">unsigned</span> <span class="nf">getrand</span><span class="p">()</span>
      <span class="p">{</span>
          <span class="k">return</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed</span><span class="o">*</span><span class="mi">13077</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6925</span><span class="p">);</span>
      <span class="p">}</span>
      </code></pre>
      
      <p>At this point, I tried the attack from the other end, a known-text attack by
      writing a C program to try and get the same result. I tried a separate
      function with a global variable <kbd>seed</kbd> and a main-local sum. The
      results both in object and assembler form were enlightening. If cno had not
      been stripped, the object code would have at once shown the structure of the
      program. By comparison, the VAX 32V code is not as helpful to identify global
      variables and functions. </p>
      
      <p>Another thing to consider is whether cno was written at a time when the system
      itself was evolving its assembler output. If the seed is calculated in a
      separate function, not only is seed moved using a different register, there is
      also extra stack management code. Cno did not exhibit the stack management
      code, so calculating the seed in <kbd>main()</kbd> might get closer to the original code.</p>
      
      <p>To my surprise, seed was <em>not</em> moved via the PC but r5 and there was still some
      stack management code missing.  It is still possible that cno used global
      variables instead of local ones, but there are still questions about this.
      Given that the assembler output suggests that the seed value was taken from a
      subroutine, it might be the linker which is evolving or changing things from
      object code to executable.</p>
      
      <h3 id="od-finding-the-throw-routine">od: Finding the Throw Routine</h3>
      
      <p>Most rewrites implement the throw as filling an array but using a different algorithm. This is more complicated, the Reno C code runs:</p>
      
      <pre class="highlight c"><code>
      <span class="kt">char</span> <span class="n">string</span> <span class="p">[</span><span class="mi">7</span><span class="p">];</span> <span class="cm">/* space for 6 digits plus terminator */</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">change</span><span class="p">();</span>  <span class="cm">/* pre-ANSI forward dec */</span>
      
      <span class="kt">int</span> <span class="n">table</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
          <span class="p">{{</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">},{</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">}},</span>
          <span class="p">{{</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">}},</span>
      <span class="p">};</span>
      
      <span class="kt">char</span> <span class="o">*</span>
      <span class="nf">change</span><span class="p">()</span>
      <span class="p">{</span>
          <span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
      
          <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span><span class="n">i</span><span class="o">+++</span><span class="p">){</span>
              <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">getrand</span><span class="p">()][</span><span class="n">getrand</span><span class="p">()][</span><span class="n">getrand</span><span class="p">()]</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">;</span>
          <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
          <span class="k">return</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
      <span class="p">}</span>
      </code></pre>
      
      <p>The Reno code actually goes a little further in randomness than this but we already know the original random code. The table in cno starts at byte 7172, just after where the seed is stored, because the seed is BSS (uninitialized) and the table is DATA (initialized).</p>
      
      <h3 id="known-plaintext-attack">Known-plaintext attack</h3>
      
      <p>I bit the bullet and compiled a version of the Reno rewrite on V7: it turns
      out to be pretty much what the original code was, except for the logfile. So,
      going back to the previous disassembly section, we can see that the helper
      functions were either all written before main(), possibly either for scoping
      reasons or thats just the way the linker reorganized the file. For instance,
      here is <kbd>char *change()</kbd> from the IDA Pro disassembly; note how call is
      substituted for internal function calls where as uses jsr pc syntax</p>
      
      <pre class="highlight cpp"><code>
      <span class="n">sub_262</span><span class="o">:</span>                                <span class="o">/</span> <span class="n">CODE</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">sub_416</span><span class="o">+</span><span class="mi">62</span>
                       <span class="n">jsr</span>     <span class="n">R5</span><span class="p">,</span> <span class="n">sub_6342</span>   <span class="o">/</span> <span class="n">csv</span>
                       <span class="n">sub</span>     <span class="err">#</span><span class="mi">6</span><span class="p">,</span> <span class="n">SP</span>
                       <span class="n">clr</span>     <span class="n">R4</span>
      
      <span class="n">loc_274</span><span class="o">:</span>                                <span class="o">/</span> <span class="n">CODE</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">sub_262</span><span class="o">+</span><span class="mi">116</span><span class="o">^</span><span class="n">Yj</span>
                       <span class="n">call</span>    <span class="n">sub_104</span>        <span class="o">/</span> <span class="n">_getrnum</span>
                       <span class="n">bic</span>     <span class="err">#</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">R0</span>
                       <span class="n">mov</span>     <span class="n">R0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">(</span><span class="n">R5</span><span class="p">)</span>
                       <span class="n">call</span>    <span class="n">sub_104</span>
                       <span class="n">bic</span>     <span class="err">#</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">R0</span>
                       <span class="n">mov</span>     <span class="n">R0</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">(</span><span class="n">R5</span><span class="p">)</span>
                       <span class="n">call</span>    <span class="n">sub_104</span>
                       <span class="n">bic</span>     <span class="err">#</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">R0</span>
                       <span class="n">mov</span>     <span class="n">R0</span><span class="p">,</span> <span class="o">-</span><span class="mi">14</span><span class="p">(</span><span class="n">R5</span><span class="p">)</span>
                       <span class="n">asl</span>     <span class="n">R0</span>
                       <span class="n">add</span>     <span class="o">-</span><span class="mi">12</span><span class="p">(</span><span class="n">R5</span><span class="p">),</span> <span class="n">R0</span>
                       <span class="n">asl</span>     <span class="n">R0</span>
                       <span class="n">add</span>     <span class="o">-</span><span class="mi">10</span><span class="p">(</span><span class="n">R5</span><span class="p">),</span> <span class="n">R0</span>
                       <span class="n">asl</span>     <span class="n">R0</span>
                       <span class="n">mov</span>     <span class="mi">7152</span><span class="p">(</span><span class="n">R0</span><span class="p">),</span> <span class="n">R0</span>   <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">_table</span>
                       <span class="n">add</span>     <span class="err">#</span><span class="mi">60</span><span class="p">,</span> <span class="n">R0</span> <span class="p">;</span> <span class="sc">'0'</span>
                       <span class="n">movb</span>    <span class="n">R0</span><span class="p">,</span> <span class="mi">10134</span><span class="p">(</span><span class="n">R4</span><span class="p">)</span>  <span class="o">/</span> <span class="k">this</span> <span class="n">is</span> <span class="n">_string</span>
                       <span class="n">inc</span>     <span class="n">R4</span>
                       <span class="n">cmp</span>     <span class="err">#</span><span class="mi">6</span><span class="p">,</span> <span class="n">R4</span>
                       <span class="n">bgt</span>     <span class="n">loc_274</span>
                       <span class="n">clrb</span>    <span class="mi">10134</span><span class="p">(</span><span class="n">R4</span><span class="p">)</span>      <span class="o">/</span> <span class="n">string</span>
                       <span class="n">mov</span>     <span class="err">#</span><span class="mi">10134</span><span class="p">,</span> <span class="n">R0</span>     <span class="o">/</span> <span class="n">again</span>
                       <span class="n">jmp</span>     <span class="n">loc_6356</span>
      </code></pre>
      
      <p>I don't know if Harris disassembled the VAX version or the PDP11 version but that is amazingly accurate. It would seem he either forgot or gave up implementing the log file, which is all that is left for me to do. The disassembly of main() indicates that this is probably where it got called, and the actual writing was done in a function.</p>
      
      <h3 id="recovering-the-v6-code">Recovering the V6 code</h3>
      
      <p>Most of the existing rewrite can be kept; the issue is that V6 was a very different beast for programming to V7.</p>
      
      <ul>
        <li>No c preprocessor. The practical upshot of this is no #includes. We can use #defines.</li>
        <li>No standard lib. This isn't exactly true, but we are more dependent on our own I/O routines than simple calls to a shared library.</li>
        <li>iolib is only good for basic I/O, like printf, getch, putch and tmpnam. Everything else has to be done ourselves. </li>
        <li>we have a bit of a crib from phx because it was unstripped: the object files of system code can be tracked that way.</li>
        <li>Both cno and phx were written at what appears to have been what I would call v6b, version 6 as the standard library was moving from libS to libc, as Dennis Ritchie formalised the library proper. This can be seen in crt0.s where the form is not of standard V6 but of the libc V6 before it became standard in V7 and changed yet again. I was able to track this using the UNSW archives which have both libraries at the critical point.</li>
      </ul>
      
      <p>This essay is a work in progress. </p>
      <p>Last updated: 2015-02-07</p>
      <a href='/computers/'>Back to computers</a>
      <!--
        Bootstrap core JavaScript
        ==================================================
      -->
      <!-- Placed at the end of the document so the pages load faster -->
    </div>
    <script src='/js/webfont.js'></script>
    <script src='/js/dofont.js'></script>
    <script src='/js/jquery.min.js'></script>
    <script src='/js/bootstrap.min.js'></script>
    <script src='/js/modernizr-latest.js'></script>
    <script src='/js/ie10-viewport-bug-workaround.js'></script>
  </body>
</html>
