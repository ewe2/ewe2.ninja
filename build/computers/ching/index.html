<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <meta content='penguin home' name='description'>
    <meta content='ewe2' name='author'>
    <link href='/favicon.ico' rel='icon'>
    <title>ewe2.ninja</title>
    <!-- font links last -->
    <!-- Bootstrap core CSS -->
    <link href='/css/bootstrap.min.css' rel='stylesheet'>
    <!-- Custom styles for this template -->
    <link href='/css/stuff.css' media='screen' rel='stylesheet'>
    <!-- Highlighting -->
    <link href='/css/rouge.css' media='screen' rel='stylesheet'>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.min.js"></script>
      <script src="/js/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/index.html" class="navbar-brand">
        ewe2.ninja
      </a>
        
      </div>
      <div class="collapse navbar-collapse" id="navbar-collapse">
        <ul class="nav navbar-nav navbar-right" id="menu">
        <li>
        <a href="/">
          home
        </a>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">stuff <b class="caret"></b></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">
        Penguin stuff
      </li>
      <li>
        <a href="/stuff/">
          stuff
        </a>
      </li>
      <li class="divider"></li>
      <li>
        <a href="/music/">
          music
        </a>
      </li>
      <li>
        <a href="/computers/">
          computers
        </a>
      </li>
      <li>
        <a href="/random/">
          random
        </a>
      </li>
      
        </ul>
      </li>
      <li>
        <a href="/about">
          about
        </a>
      </li>
      
      </ul>
      
      </div>
    </nav>
    <div class='container-stuff'>
      <h2 id="the-strange-case-of-the-kbdchingkbd6-in-the-unix">The strange case of the <kbd>ching</kbd>(6) in the Unix</h2>
      
      <p>There are many mysteries of the early days of Unix. Because it grew organically, there wasn't really
      anyone in charge of care and feeding except Dennis and Ken and the Bell Labs crews initial work.
      Inevitably, things didn't get documented (after all, they were <em>doing stuff</em> not writing it up) and
      some contributions got forgotten. When Don Libes wrote <em>Life With Unix: A Guide for Everyone</em> back
      in the early 1990's, he found it impossible to track everything down even with his contacts and
      experience in the early Internet age. It was already 20 years too late. So the mystery of <kbd>ching</kbd> is
      likely to remain one, even if it is a small mystery.</p>
      
      <h3 id="discovery">Discovery</h3>
      
      <p>I first discovered <kbd>ching</kbd> in the early 1990's also. Back then people were innocent enough to throw
      all sorts of things on the big ftp sites of the time, and CSRG were incautious enough to throw parts
      of BSD online before checking with USL if that was okay. And people were very keen to port
      everything to Linux also, so a lot of SunOS stuff, quite illegally, was also being thrown on there.
      Of course, this didn't last long, but while it did, there were a few things that slipped through,
      even on to commercial CDs. One of these was the Infomagic series which was just dumps of
      sunsite.unc.edu and tsx-11.mit.edu mainly, whatever was current because it was a resource for Linux
      enthusiasts. And a version of BSD, probably 4.4 BSD-Lite1, was also online, and this was how I was
      able to acquire a version of <kbd>ching</kbd>, and that version was incomplete. But let's start at the
      beginning.</p>
      
      <h3 id="original-kbdchingkbd-1978-v6---1979-v7">Original <kbd>ching</kbd> (1978? V6 - 1979 V7)</h3>
      
      <p>We <em>think</em> that <kbd>ching</kbd> started with V7 because we have an original tape and the timestamped Pdp-11
      binaries.  But that's not the real truth. Although <kbd>ching</kbd> made it into the official V7 tape, it came
      without the sourcecode or any indication of who wrote it. The binaries themselves aren't even V7,
      they're V6 and not even original V6 but what I would call V6B or proto-V7, a development before the
      stdio library was in its fixed form but after the first wave of development, called libS which
      superseded the old iolib. We can see this because the binaries themselves exhibit a specific form of
      C setup code contained in crt0.s that did not exist except at this specific time when the core libraries
      were in redevelopment. In addition, although <kbd>cno</kbd> (Copy Numerical Output) was stripped, and
      therefore difficult to track, phx (Print Hexagrams) was <em>not</em> stripped and we can see the
      object files it needed from the system to link as an executable, and these too are specifically from
      this period. The mystery of the loss of the sourcecode has its origin here: too popular to let
      bitrot in the V6 upheavals, it worked well enough in V7 to survive. This set the tone of the <kbd>ching</kbd>
      story ever afterwards.</p>
      
      <p>More famous than the program itself is the appropriately cryptic manpage. The
      "game" itself was a collection, not a single file. It ran from a shell script
      to allow users to input numbers from a coin toss directly or to frame a
      question to <kbd>ching</kbd> and have that translated to numbers first before output. To
      do this it used the <kbd>cno</kbd> and phx binaries,  an nroff-formatted text file of the
      hexagrams (called <kbd>hexagrams</kbd>) and a file of macros ( called
      <kbd>macros</kbd>) that the hexagram output would be filtered through. All
      these except the shell script was in a directory of its own within
      <kbd>/usr/games</kbd>. This demonstrates the early use of the Unix tools
      philosophy of specific programs that do specific jobs very well. Here's the
      original shell script source:</p>
      
      <pre class="highlight shell"><code>
      <span class="c">#! /bin/sh</span>
      <span class="nb">cd</span> /usr/games/lib/&lt;kbd&gt;ching&lt;/kbd&gt;.d
      <span class="nv">PATH</span><span class="o">=</span>:<span class="nv">$PATH</span>
      <span class="k">case</span> <span class="nv">$1</span> <span class="k">in</span>
              <span class="o">[</span>6-9]<span class="k">*</span><span class="p">)</span> <span class="nv">H</span><span class="o">=</span><span class="nv">$1</span>;<span class="nb">shift</span><span class="p">;;</span>
      <span class="k">esac</span>
      <span class="k">if      </span><span class="nb">test</span> <span class="nv">$H</span>
      <span class="k">then    </span>phx <span class="nv">$H</span> | nroff <span class="nv">$*</span> macros -
      <span class="k">else</span>   &lt;kbd&gt;cno&lt;/kbd&gt;| phx | nroff <span class="nv">$*</span> macros -
      <span class="k">fi</span>
      </code></pre>
      
      <p>Over the years, this general organization remained but as we'll see, things
      get more complicated. Another important component of the original
      <kbd>cno</kbd> is that it kept a log of questions, which was appended to a text
      file called log in the current directory; if it couldn't find the log, or
      something was wrong with its format (I'm not sure which at this stage), it
      would print out an error message. Over the years, you can track the
      differences in the <kbd>cno</kbd> binary by the existence of this log and the code for
      it.</p>
      
      <p>A note about the hexagrams file: this was clearly modelled on the Wilhelm
      translation of the I Ching. It uses the same organization of oracle and
      interpretations, and strictly speaking this is an infringement of the English
      translation copyright. Further, it appears from a post to comp.os.bsd in 1994
      from Keith Bostic, that at least the nroff macros were contestable under the
      USL settlement and thus <kbd>ching</kbd> had never appeared in 4.4 BSD.No-one seems to
      have tried to rewrite <kbd>hexagrams</kbd> or <kbd>macros</kbd> to use the
      public domain Legge text or groff however. It was not until Caldera freed 32v
      that it was realized that <kbd>ching</kbd> itself was now freed, see below.</p>
      
      <h3 id="vax-kbdchingkbd-unix32v-1979">VAX <kbd>ching</kbd> (UNIX/32v 1979)</h3>
      
      <p>The mystery deepens when we look at the first port of V7 to the VAX. It is now
      possible to run a 32v system in emulation with the SIMH vax780 simulator and
      we find that <kbd>ching</kbd> had also been ported <em>with vax executables</em> along with it.
      Still no sign of source code - in fact the one system available has no
      sourcecode for the other games except fortune.c. The timestamps are December
      1978, well before its official release in June 1979. 32v is crucial to the
      history of later Unix, both System V and BSD derive from this port. This is
      likely to have been the last time source code was available. I believe the
      reason <kbd>ching</kbd> survived at all was because the surviving 32v executables were
      still usable on VAX-based BSD derivatives for as much as 10 years later! We
      can definitively say that this was the last time the code was actually
      <em>compiled</em>, but it seems later <kbd>cno</kbd> itself may have been <em>changed</em>.</p>
      
      <p>But things are a little more interesting than that. <kbd>phx</kbd> certainly
      survived unchanged, even unstripped. <kbd>cno</kbd> however has lost the log
      file code! This is important because the <kbd>cno</kbd> here is <em>not</em> the
      <kbd>cno</kbd> that survived in later BSD distributions! It's also valuable
      because being not stripped, one can see the functions, variables and linked
      library code.  Weirdly, the log file was left as it was and actually survived
      into 3bsd, even though it was redundant!</p>
      
      <p>It should be noted that Unix SYSIII| Unix System III did <em>not</em> carry <kbd>ching</kbd>,
      and it is likely that, if no source was available, most V7-derived games also
      missed the cut besides <kbd>ching</kbd> from then on, including derivatives even if they
      extended theirs with BSD.</p>
      
      <h3 id="bsd-kbdchingkbd-1979-1990-">BSD <kbd>ching</kbd> (1979-1990 )</h3>
      
      <p>The first VAX BSD was released only six months later and on first sight,
      appears to have identical binaries, but it is not that simple. Up to 3BSD, BSD
      was still supported on PDP11 hardware. The 2.9BSD binaries are still standard
      headers and look like they're the untouched v7 executables. On 3BSD however,
      it looks like they're the 32v executables: unstripped and <kbd>cno</kbd> has no log file
      code, but like the 32v port, it's still left in the directory. But there is a
      crucial difference in the <kbd>cno</kbd> binary: 32v was essentially a minimal port
      without all the VAX bells and whistles, so PDP11 executables had a "text
      read-only" magic number, 0410 instead of 0407. But in the 3bsd executables,
      there is a marked difference in the size of the symbol table! 3bsd did have a
      different executable structure, but how did <kbd>cno</kbd> acquire this difference and
      why was phx left unchanged? The extent of the change is apparent from a
      <kbd>cmp -lb cno.32v cno.3bsd</kbd>. The header has been extended by 21 bytes,
      and there are significantly large new areas which I am assuming are due to
      3bsd's relocation requirements. But how the hell this was managed is a mystery
      unless someone had access to an object file and then processed it with ld: it
      would have taken a significant effort to alter the binary in another way. And
      this is an unstripped binary: the stripped binary found in 4BSD onwards
      completely does away with all the alteration. And yet phx remained unchanged
      except stripped throughout!</p>
      
      <p>There is one other possibility: the 2BSD source indicates the struggle to
      upgrade v6 to v7 code for existing systems, still on PDP11 hardware. If
      someone had access to the sourcecode during this period where BSD was just a
      collection of updates and additions, it's possible that<kbd>cno</kbd>was modified.</p>
      
      <p>It was not until the Reno port of 4.3 BSD that <kbd>ching</kbd> had to actually be
      rewritten. This situation was replicated in other BSD variants, for instance
      Ultrix and Dynix.</p>
      
      <h3 id="ching-rewrites-19881990">Ching Rewrites (1988,1990)</h3>
      
      <p>We now come to rewrites. One of the oddities of the 4.4 BSD-Lite1 release was
      that the macros and the hexagrams files went missing, but the rewrites of
      <kbd>ching.sh</kbd>, <kbd>ching.cno.c</kbd> and <kbd>ching.phx.c</kbd>
      remained. But now that the many BSD and research versions are freely
      available, we can see that the data files remained untouched for many years,
      even as the other files changed or went missing around them.</p>
      
      <p><kbd>ching.sh</kbd> itself went through the usual contortions of early version
      control. I have found 3 different dated versions based on Berkeley code alone
      and the VC timestamps don't make much sense.</p>
      
      <p>The 4.3 BSD Reno port finally broke the back of pure VAX executables and a
      rewrite was required. Guy Harris is credited: how he did it
      (reverse-engineering? decompilation?) is not known; but the new versions of
      cno and phx were able to work with the existing data files and shell script.
      This was the version that made it into successors, but <em>not</em> 4.4BSD. Keith
      Bostic believed it was because USL claimed nroff macros to be proprietory, but
      one would have thought the <kbd>hexagrams</kbd> file warranted some copyright
      attention too! I never understood this omission until 32v was freed.</p>
      
      <p>The last major rewrite I've seen was for NetBSD 5.1 for the VAX. This rewrite
      was by Perry Metzger in 2005, realizing that the freeing of 32v meant that the
      data files (and nroff macros) were able to be distributed, and that little
      mystery was finally solved.</p>
      
      <p>Now we come to another fork in the road, SunOS. This generally tracked CSRG
      releases until they developed their own SPARC architecture which at last
      forced a rewrite. It was reverse-engineered by Tom Lyon who credits Ralph Muha
      as being the original source of <kbd>ching</kbd>.</p>
      
      <h4 id="summary-of-differences-between-kbdchingkbd-versions">Summary of differences between <kbd>ching</kbd> versions</h4>
      
      <p>This is not an exhaustive list: many BSD VAX variants carried <kbd>ching</kbd>(6) without modification from the 3BSD binaries (eg Ultrix).</p>
      
      <table class="wiki-table" width="100%" style="font-size: 8pt;">
      <tr>
      <th> Unix version
      </th>
      <th> V7
      </th>
      <th> 32V
      </th>
      <th> 2.9BSD
      </th>
      <th> 3BSD
      </th>
      <th> 4BSD
      </th>
      <th> 4.3 Reno
      </th>
      <th> 4.4BSD
      </th>
      <th> SunOS 4.1.4
      </th>
      <th> NetBSD 5.1
      </th>
      <th> Notes
      </th></tr>
      <tr>
      <th>Format
      </th>
      <td>PDP11 0407
      </td>
      <td>VAX 0410
      </td>
      <td>V7 binary
      </td>
      <td>32V binary
      </td>
      <td>3BSD binary
      </td>
      <td>source rewrite
      </td>
      <td>Reno source rewrite
      </td>
      <td>Reverse-engineer rewrite
      </td>
      <td>44BSD source rewrite
      </td>
      <td>32v version last source modification.
      </td></tr>
      <tr>
      <th>cno
      </th>
      <td>Stripped
      </td>
      <td>Unstripped
      </td>
      <td>Stripped
      </td>
      <td>Unstripped, altered
      </td>
      <td>Stripped
      </td>
      <td>ching.cno.c with header
      </td>
      <td>Same as Reno rewrite
      </td>
      <td>Rewritten
      </td>
      <td>castching.c
      </td>
      <td>Altered cno version carried forward.
      </td></tr>
      <tr>
      <th>phx
      </th>
      <td>Unstripped
      </td>
      <td>Unstripped
      </td>
      <td>Unstripped
      </td>
      <td>Unstripped
      </td>
      <td>Stripped
      </td>
      <td>ching.phx.c with header
      </td>
      <td>Same as Reno rewrite
      </td>
      <td>Rewritten
      </td>
      <td>printching.c+
      </td>
      <td>phx has the original table and dedication to Muha<br />
      <p>+has a different hexagram table.
      </p>
      </td></tr>
      <tr>
      <th>Data files
      </th>
      <td>logfile
      </td>
      <td>no logfile
      </td>
      <td>logfile
      </td>
      <td>no logfile
      </td>
      <td>no logfile
      </td>
      <td>hexagrams modified for spelling and macros
      </td>
      <td>Released without data files
      </td>
      <td>Reno hexagrams version
      </td>
      <td>Reno hexagrams and macros modified
      </td>
      <td>
      </td></tr></table>
      
      <h3 id="the-mystery">The Mystery</h3>
      
      <p>Many questions remain: why didn't Muha's source survive transmission? The
      truth is, many files didn't. For example, in the one 32v distribution
      available, the only game source is <kbd>fortune.c</kbd> The source to maze(6)
      is completely missing and it was never passed onto 32v. Many of the games we
      know from historical Unix are in fact of BSD origin, not AT&amp;T.</p>
      
      <p>So it's difficult to ascribe any particular motive for <kbd>ching</kbd> going missing.
      Why was the code altered to remove the log file? Why and how was<kbd>cno</kbd>altered
      from the 32v executable in 3bsd? Was there a reason for<kbd>cno</kbd>being stripped and
      phx not, or was that just an accident of circumstance?</p>
      
      <h3 id="see-also">See Also</h3>
      
      <p><a href="/computers/cno/">An Exploration of Cno</a></p>
      <p>Last updated: 2016-01-24</p>
      <a href='/computers'>Back to computers</a>
      <!--
        Bootstrap core JavaScript
        ==================================================
      -->
      <!-- Placed at the end of the document so the pages load faster -->
    </div>
    <script src='/js/webfont.js'></script>
    <script src='/js/dofont.js'></script>
    <script src='/js/jquery.min.js'></script>
    <script src='/js/bootstrap.min.js'></script>
    <script src='/js/modernizr-latest.js'></script>
    <script src='/js/ie10-viewport-bug-workaround.js'></script>
  </body>
</html>
